<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freetify - Advanced</title>
    <style>
        :root {
            --primary-bg: #121212;
            --secondary-bg: #181818;
            --tertiary-bg: #282828;
            --modal-bg: #2a2a2a;
            --text-primary: #FFFFFF;
            --text-secondary: #B3B3B3;
            --accent-color: #1DB954; /* Spotify Green */
            --danger-color: #e74c3c;
            --font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 100%;
            height: calc(100% - 90px); /* Adjust for enhanced player bar */
        }

        .sidebar {
            width: 240px;
            background-color: #000000;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .sidebar .logo {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .user-profile {
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--secondary-bg);
            border-radius: 5px;
        }
        .user-profile input[type="text"], .user-profile input[type="email"] {
            width: calc(100% - 22px);
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 3px;
            border: none;
            background-color: var(--tertiary-bg);
            color: var(--text-primary);
        }
        .user-profile button {
            width: 100%;
            padding: 8px;
            background-color: var(--accent-color);
            color: var(--text-primary);
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .user-profile p { font-size: 0.9em; margin-top: 10px; }
        .user-profile .admin-badge { color: var(--accent-color); font-weight: bold; }

        .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar nav li {
            padding: 12px 0;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: bold;
            transition: color 0.2s;
            display: flex;
            align-items: center;
        }
        .sidebar nav li svg { margin-right: 10px; width: 20px; height: 20px; fill: currentColor; }
        .sidebar nav li:hover, .sidebar nav li.active-nav { color: var(--text-primary); }
        .sidebar nav li.sub-item { padding-left: 20px; font-weight: normal; }
        .sidebar #playlists-nav-section h4 { margin: 15px 0 5px; color: var(--text-secondary); font-size: 0.9em;}
        .sidebar #user-playlists-list li { font-weight: normal; font-size: 0.95em; padding-left: 10px; }


        .main-content {
            flex-grow: 1;
            background: linear-gradient(to bottom, var(--tertiary-bg) 0%, var(--primary-bg) 300px);
            padding: 20px;
            overflow-y: auto;
            height: 100%;
            box-sizing: border-box;
        }

        .view { display: none; }
        .view.active { display: block; }
        .view h2 { border-bottom: 1px solid var(--secondary-bg); padding-bottom: 10px; margin-top: 0; }
        .view h3 { margin-top: 30px; margin-bottom: 15px; }

        .song-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px; /* Increased gap */
        }

        .song-card {
            background-color: var(--secondary-bg);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .song-card:hover { background-color: var(--tertiary-bg); }
        .song-card img.cover {
            width: 100%;
            aspect-ratio: 1/1; /* Square covers */
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 12px;
        }
        .song-card .song-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .song-card .artist-name, .song-card .uploader-name, .song-card .song-plays, .song-card .song-likes, .song-card .song-album {
            font-size: 0.85em; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px;
        }
        .song-card .privacy-status { font-size: 0.75em; color: var(--accent-color); position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.5); padding: 2px 4px; border-radius: 3px;}

        .song-card .actions-overlay {
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 8px;
        }
        .song-card:hover .actions-overlay { opacity: 1; }
        .song-card .actions-overlay button {
            background: var(--accent-color); color: white; border: none;
            padding: 8px 12px; margin: 5px; border-radius: 20px; cursor: pointer;
            font-size: 0.9em;
        }
        .song-card .actions-overlay button.admin-action { background: var(--danger-color); }
        .song-card .like-button-card { /* Renamed from like-button to avoid conflict */
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.8em; /* Larger heart */
            cursor: pointer;
            z-index: 5; /* Above overlay if needed */
        }
        .song-card .like-button-card.liked { color: var(--accent-color); }


        .player-bar {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            height: 90px; /* Increased height */
            background-color: #181818; /* Darker than tertiary for distinction */
            display: none; /* Initially hidden */
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            border-top: 1px solid #000;
            justify-content: space-between;
        }
        .player-bar .player-info-left { display: flex; align-items: center; min-width: 200px;}
        .player-bar #playerCover { width: 60px; height: 60px; object-fit: cover; margin-right: 15px; border-radius: 4px; }
        .player-bar #playerName { margin: 0 0 5px 0; font-weight: bold; font-size: 0.9em; }
        .player-bar #playerArtist { margin: 0; font-size: 0.8em; color: var(--text-secondary); }

        .player-controls-center { display: flex; flex-direction: column; align-items: center; flex-grow: 1; max-width: 600px; }
        .player-controls-center .buttons { margin-bottom: 8px; }
        .player-controls-center button { background: none; border: none; color: var(--text-secondary); font-size: 1.5em; cursor: pointer; margin: 0 10px; }
        .player-controls-center button:hover { color: var(--text-primary); }
        .player-controls-center .progress-container { display: flex; align-items: center; width: 100%; }
        .player-controls-center #currentTime { font-size: 0.8em; margin-right: 10px; }
        .player-controls-center #seekBar { flex-grow: 1; height: 4px; -webkit-appearance: none; appearance: none; background: #404040; border-radius: 2px; cursor: pointer; }
        .player-controls-center #seekBar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: var(--text-primary); border-radius: 50%; cursor: pointer; }
        .player-controls-center #totalTime { font-size: 0.8em; margin-left: 10px; }
        
        .player-controls-right { display: flex; align-items: center; min-width: 150px; justify-content: flex-end;}
        .player-controls-right #volumeIcon { margin-right: 8px; }
        .player-controls-right #volumeBar { width: 100px; height: 4px; -webkit-appearance: none; appearance: none; background: #404040; border-radius: 2px; cursor: pointer; }
        .player-controls-right #volumeBar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: var(--text-primary); border-radius: 50%; cursor: pointer; }


        /* Upload, Search, Modals */
        #uploadForm div, .search-controls div, .modal-content div { margin-bottom: 15px; }
        #uploadForm label, .search-controls label, .modal-content label { display: block; margin-bottom: 5px; color: var(--text-secondary); }
        #uploadForm input[type="text"], #uploadForm input[type="file"], #uploadForm select,
        .search-controls input[type="text"], .search-controls select,
        .modal-content input[type="text"], .modal-content select, .modal-content textarea {
            width: 100%; padding: 10px; background-color: var(--tertiary-bg);
            border: 1px solid var(--secondary-bg); border-radius: 4px; color: var(--text-primary); box-sizing: border-box;
        }
        #uploadForm button, .search-controls button, .modal-content button {
            padding: 10px 20px; background-color: var(--accent-color); color: var(--text-primary);
            border: none; border-radius: 20px; cursor: pointer; font-weight: bold;
        }
        #uploadForm button:hover, .search-controls button:hover, .modal-content button:hover { opacity: 0.9; }
        .error-message { color: #ff6b6b; font-size: 0.9em; }
        #coverPreview { max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 4px; }
        .search-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 20px; }
        .search-controls input[type="text"], .search-controls select { width: auto; flex-grow: 1; }
        .search-controls #filterValueInput { flex-grow: 2; }

        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--modal-bg); margin: auto; padding: 25px;
            border: 1px solid var(--tertiary-bg); width: 80%; max-width: 500px;
            border-radius: 8px; position: relative;
        }
        .modal-content h3 { margin-top: 0; }
        .close-button {
            color: var(--text-secondary); position: absolute; top: 15px; right: 20px;
            font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .close-button:hover, .close-button:focus { color: var(--text-primary); text-decoration: none; }

        /* Song Detail Modal & Comments */
        #songDetailModal .song-detail-info { display: flex; margin-bottom: 20px; }
        #songDetailModal #detailCover { width: 150px; height: 150px; object-fit: cover; border-radius: 6px; margin-right: 20px; }
        #songDetailModal .info-text p { margin: 5px 0; }
        #songDetailModal .info-text .detail-name { font-size: 1.5em; font-weight: bold; }
        #songDetailModal .info-text .detail-artist { font-size: 1.1em; color: var(--text-secondary); }
        
        .comments-section { margin-top: 20px; }
        .comments-section h4 { margin-bottom: 10px; }
        #commentsList .comment {
            background-color: var(--tertiary-bg); padding: 10px; border-radius: 5px; margin-bottom: 8px;
            font-size: 0.9em;
        }
        #commentsList .comment-user { font-weight: bold; color: var(--accent-color); margin-right: 8px; }
        #commentsList .comment-time { font-size: 0.8em; color: var(--text-secondary); }
        #commentsList .comment-text { margin-top: 4px; }
        #commentForm textarea { height: 60px; margin-bottom: 10px; }

        /* Playlist specific */
        #createPlaylistInput { margin-bottom: 10px; }
        .playlist-card {
            background-color: var(--secondary-bg); padding: 15px; border-radius: 8px;
            cursor: pointer; transition: background-color 0.2s;
        }
        .playlist-card:hover { background-color: var(--tertiary-bg); }
        .playlist-card h4 { margin-top:0; }
        .playlist-card p { font-size: 0.9em; color: var(--text-secondary); }

        /* Responsive */
        @media (max-width: 768px) {
            .container { flex-direction: column; height: calc(100% - 70px); /* Player bar might be smaller on mobile */ }
            .sidebar { width: 100%; height: auto; max-height: 40vh; overflow-y: auto; padding: 10px; }
            .main-content { padding: 15px; }
            .song-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
            .player-bar { flex-direction: column; height: auto; padding: 10px; }
            .player-info-left { margin-bottom: 10px; width: 100%; justify-content: center; text-align: center; }
            .player-controls-center { width: 100%; }
            .player-controls-right { width: 100%; justify-content: center; margin-top: 10px; }
            .search-controls { flex-direction: column; }
            .search-controls input[type="text"], .search-controls select { width: 100%; }
            .modal-content { width: 90%; }
        }

    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h1 class="logo">Freetify</h1>
            <div class="user-profile">
                <input type="text" id="usernameInput" placeholder="Username">
                <input type="email" id="emailInput" placeholder="Email">
                <button id="setUserButton">Set/Login User</button>
                <p>User: <span id="currentUserDisplay">None</span> <span id="adminBadge" class="admin-badge" style="display:none;">(Admin)</span></p>
            </div>
            <nav>
                <ul>
                    <li data-view="home" class="active-nav">
                        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home
                    </li>
                    <li data-view="search">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>Search
                    </li>
                    <li data-view="library">
                        <svg viewBox="0 0 24 24"><path d="M2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2zm18-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H8V8h4V4h2v4h4v2z"/></svg>Library
                    </li>
                    <li data-view="upload" class="sub-item">
                        <svg viewBox="0 0 24 24" style="margin-left:15px;"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>Upload Song
                    </li>
                </ul>
                <div id="playlists-nav-section">
                    <h4>PLAYLISTS</h4>
                    <input type="text" id="createPlaylistInput" placeholder="New Playlist Name" style="width: calc(100% - 22px); padding: 6px; font-size:0.9em; margin-bottom:5px;">
                    <button id="createPlaylistButton" style="width:100%; font-size:0.9em; padding: 6px;">Create Playlist</button>
                    <ul id="user-playlists-list">
                        <!-- User playlists will be listed here -->
                    </ul>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <section id="home-view" class="view active">
                <h2>Home</h2>
                <div id="recently-played-section">
                    <h3>Recently Played By You</h3>
                    <div class="song-grid" id="recently-played-grid"><p>Play some songs to see them here!</p></div>
                </div>
                <div id="recently-uploaded-section">
                    <h3>Recently Uploaded</h3>
                    <div class="song-grid" id="recently-uploaded-grid"><p>No songs uploaded yet.</p></div>
                </div>
                <div id="most-played-section">
                    <h3>Most Plays</h3>
                    <div class="song-grid" id="most-played-grid"><p>No songs played yet.</p></div>
                </div>
                 <div id="most-liked-section">
                    <h3>Most Likes</h3>
                    <div class="song-grid" id="most-liked-grid"><p>No songs liked yet.</p></div>
                </div>
            </section>

            <section id="search-view" class="view">
                <h2>Search Songs</h2>
                <div class="search-controls">
                    <input type="text" id="searchInput" placeholder="Search songs, artists, albums...">
                    <select id="filterType">
                        <option value="all">All Fields</option>
                        <option value="recent">Most Recent</option>
                        <option value="uploader">By Uploader</option>
                        <option value="artist">By Artist</option>
                        <option value="album">By Album</option>
                        <option value="category">By Category</option>
                        <option value="most_played">Most Played</option>
                        <option value="most_liked">Most Liked</option>
                    </select>
                    <input type="text" id="filterValueInput" placeholder="Enter filter value" style="display: none;">
                    <button id="searchButton">Search</button>
                </div>
                <div class="song-grid" id="search-results-grid"><p>Enter search term and click Search.</p></div>
            </section>

            <section id="library-view" class="view">
                <h2>My Library</h2>
                 <div id="my-uploads-section">
                    <h3>My Uploads</h3>
                    <div class="song-grid" id="my-uploads-grid"><p>You haven't uploaded any songs.</p></div>
                </div>
                <div id="my-liked-songs-section">
                    <h3>My Liked Songs</h3>
                    <div class="song-grid" id="my-liked-songs-grid"><p>You haven't liked any songs.</p></div>
                </div>
                <div id="my-playlists-section">
                    <h3>My Playlists</h3>
                    <div id="my-playlists-grid" class="song-grid"> <!-- Re-using song-grid for layout -->
                        <p>You haven't created any playlists.</p>
                    </div>
                </div>
            </section>
            
            <section id="playlist-detail-view" class="view">
                <h2 id="playlistDetailName">Playlist: </h2>
                <button id="backToLibraryButton" style="margin-bottom:15px;">&larr; Back to Library</button>
                <div class="song-grid" id="playlist-songs-grid"><p>This playlist is empty.</p></div>
            </section>

            <section id="upload-view" class="view">
                <h2>Upload Song</h2>
                <form id="uploadForm">
                    <div>
                        <label for="songFile">Song (MP3/OGG, <10min):</label>
                        <input type="file" id="songFile" accept=".mp3,.ogg" required>
                        <small id="songFileError" class="error-message"></small>
                    </div>
                    <div><label for="songName">Song Name:</label><input type="text" id="songName" required></div>
                    <div><label for="artistName">Artist Name:</label><input type="text" id="artistName" required></div>
                    <div>
                        <label for="coverFile">Cover (PNG/JPG/JPEG):</label>
                        <input type="file" id="coverFile" accept=".png,.jpg,.jpeg" required>
                        <img id="coverPreview" src="#" alt="Cover Preview" style="display: none;">
                    </div>
                    <div>
                        <label for="category">Category:</label>
                        <select id="category">
                            <option value="Hip Hop">Hip Hop</option> <option value="Dance">Dance</option> <option value="EDM">EDM</option>
                            <option value="Dubstep">Dubstep</option> <option value="Phonk">Phonk</option> <option value="Rock">Rock</option>
                            <option value="Pop">Pop</option> <option value="Classical">Classical</option> <option value="Jazz">Jazz</option>
                            <option value="Other" selected>Other</option>
                        </select>
                    </div>
                    <div><label for="albumName">Album Name (optional):</label><input type="text" id="albumName" placeholder="No Album"></div>
                    <button type="submit">Upload Song</button>
                </form>
            </section>
        </main>
    </div>

    <div class="player-bar" id="playerBar">
        <div class="player-info-left">
            <img id="playerCover" src="#" alt="Track Cover">
            <div>
                <p id="playerName">Song Name</p>
                <p id="playerArtist">Artist</p>
            </div>
        </div>
        <div class="player-controls-center">
            <div class="buttons">
                <button id="prevTrackButton" title="Previous">≪</button>
                <button id="playPauseButton" title="Play/Pause">▶</button>
                <button id="nextTrackButton" title="Next">≫</button>
                <button id="repeatButton" title="Repeat">🔁</button>
                <button id="shuffleButton" title="Shuffle">🔀</button>
            </div>
            <div class="progress-container">
                <span id="currentTime">0:00</span>
                <input type="range" id="seekBar" value="0" min="0" max="100">
                <span id="totalTime">0:00</span>
            </div>
        </div>
        <div class="player-controls-right">
            <svg id="volumeIcon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
            <input type="range" id="volumeBar" value="1" min="0" max="1" step="0.01">
        </div>
        <audio id="audioPlayer"></audio>
    </div>

    <!-- Edit Song Modal -->
    <div id="editSongModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="editSongModal">&times;</span>
            <h3>Edit Song</h3>
            <form id="editSongForm">
                <input type="hidden" id="editSongId">
                <div><label for="editSongName">Song Name:</label><input type="text" id="editSongName" required></div>
                <div><label for="editArtistName">Artist Name:</label><input type="text" id="editArtistName" required></div>
                <div><label for="editAlbumName">Album Name:</label><input type="text" id="editAlbumName"></div>
                <div>
                    <label for="editCategory">Category:</label>
                    <select id="editCategory">
                        <option value="Hip Hop">Hip Hop</option> <option value="Dance">Dance</option> <option value="EDM">EDM</option>
                        <option value="Dubstep">Dubstep</option> <option value="Phonk">Phonk</option> <option value="Rock">Rock</option>
                        <option value="Pop">Pop</option> <option value="Classical">Classical</option> <option value="Jazz">Jazz</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="editIsPrivate">Private Song:</label>
                    <input type="checkbox" id="editIsPrivate" style="width:auto;">
                </div>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Song Detail Modal (for comments, etc.) -->
    <div id="songDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" data-modal-id="songDetailModal">&times;</span>
            <div class="song-detail-info">
                <img id="detailCover" src="#" alt="Cover">
                <div class="info-text">
                    <h3 id="detailName" class="detail-name">Song Name</h3>
                    <p id="detailArtist" class="detail-artist">Artist</p>
                    <p id="detailAlbum">Album: </p>
                    <p id="detailCategory">Category: </p>
                    <p id="detailUploader">Uploaded by: </p>
                    <p id="detailPlays">Plays: </p>
                    <p id="detailLikes">Likes: </p>
                </div>
            </div>
            <div class="comments-section">
                <h4>Comments</h4>
                <div id="commentsList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Comments will be listed here -->
                </div>
                <form id="commentForm">
                    <input type="hidden" id="commentSongId">
                    <textarea id="commentText" placeholder="Write a comment..." required></textarea>
                    <button type="submit">Post Comment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div id="addToPlaylistModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="addToPlaylistModal">&times;</span>
            <h3>Add to Playlist</h3>
            <input type="hidden" id="songIdToAddToPlaylist">
            <select id="playlistSelectForAdding" style="width:100%; margin-bottom:15px; padding:10px;">
                <!-- Options will be populated by JS -->
            </select>
            <button id="confirmAddToPlaylistButton">Add to Selected Playlist</button>
        </div>
    </div>


    <script>
    // --- START OF SCRIPT --- //
    // --- Globals & State ---
    let songs = [];
    let usersData = {}; // { username: { email: '', recentlyPlayed: [], likedSongs: [], playlists: [{id, name, songIds:[]}] } }
    let currentUser = null;
    let currentUserEmail = null; // For admin check
    let isAdmin = false;
    let currentPlayingSongId = null;
    let currentPlaylist = []; // For shuffle/repeat context
    let currentPlaylistIndex = -1;
    let isShuffle = false;
    let repeatMode = 'none'; // 'none', 'one', 'all'

    const MAX_SONG_DURATION = 10 * 60; // 10 minutes

    // --- DOM Elements ---
    const views = document.querySelectorAll('.view');
    const navLinks = document.querySelectorAll('.sidebar nav li[data-view]');
    
    const audioPlayer = document.getElementById('audioPlayer');
    const playerBar = document.getElementById('playerBar');
    const playerCover = document.getElementById('playerCover');
    const playerNameEl = document.getElementById('playerName');
    const playerArtistEl = document.getElementById('playerArtist');
    const playPauseButton = document.getElementById('playPauseButton');
    const prevTrackButton = document.getElementById('prevTrackButton');
    const nextTrackButton = document.getElementById('nextTrackButton');
    const seekBar = document.getElementById('seekBar');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const volumeBar = document.getElementById('volumeBar');
    const volumeIcon = document.getElementById('volumeIcon');
    const repeatButton = document.getElementById('repeatButton');
    const shuffleButton = document.getElementById('shuffleButton');

    const usernameInput = document.getElementById('usernameInput');
    const emailInput = document.getElementById('emailInput');
    const setUserButton = document.getElementById('setUserButton');
    const currentUserDisplay = document.getElementById('currentUserDisplay');
    const adminBadge = document.getElementById('adminBadge');

    const uploadForm = document.getElementById('uploadForm');
    const songFileInput = document.getElementById('songFile');
    const songFileError = document.getElementById('songFileError');
    const coverPreview = document.getElementById('coverPreview');
    const coverFileInput = document.getElementById('coverFile');

    const searchInput = document.getElementById('searchInput');
    const filterTypeSelect = document.getElementById('filterType');
    const filterValueInput = document.getElementById('filterValueInput');
    const searchButton = document.getElementById('searchButton');

    const editSongModal = document.getElementById('editSongModal');
    const editSongForm = document.getElementById('editSongForm');
    const songDetailModal = document.getElementById('songDetailModal');
    const commentForm = document.getElementById('commentForm');
    const commentsList = document.getElementById('commentsList');
    const addToPlaylistModal = document.getElementById('addToPlaylistModal');


    // --- Initialization ---
    function init() {
        loadData();
        updateCurrentUserDisplay();
        setupEventListeners();
        navigateToView('home'); 
        renderAllDynamicContent();
        audioPlayer.volume = parseFloat(localStorage.getItem('freetify_volume') || '1');
        volumeBar.value = audioPlayer.volume;
        updateVolumeIcon();

        // Initial player bar state
        if (!audioPlayer.paused || audioPlayer.currentTime > 0) {
            playerBar.style.display = 'flex';
        } else {
            playerBar.style.display = 'none';
        }
    }

    // --- Data Management (localStorage) ---
    function loadData() {
        songs = JSON.parse(localStorage.getItem('freetify_songs_v2')) || [];
        usersData = JSON.parse(localStorage.getItem('freetify_usersData_v2')) || {};
        currentUser = localStorage.getItem('freetify_currentUser_v2') || null;
        if (currentUser && usersData[currentUser]) {
            currentUserEmail = usersData[currentUser].email || null;
        }
        checkAdminStatus();
    }

    function saveData() {
        // Filter out blob objects before saving songs
        const songsToSave = songs.map(s => {
            const { songBlob, ...rest } = s; // Exclude songBlob
            return rest;
        });
        localStorage.setItem('freetify_songs_v2', JSON.stringify(songsToSave));
        localStorage.setItem('freetify_usersData_v2', JSON.stringify(usersData));
        localStorage.setItem('freetify_currentUser_v2', currentUser || '');
    }
    
    // Call this function whenever songs or usersData is modified significantly
    function refreshAllViewsAndData() {
        saveData();
        renderAllDynamicContent(); 
    }

    function renderAllDynamicContent() {
        // This function will re-render all sections that depend on songs or userData
        // Call after major data changes (upload, edit, delete, like, play, comment, playlist change)
        if (document.getElementById('home-view').classList.contains('active')) renderAllHomeSections();
        if (document.getElementById('library-view').classList.contains('active')) renderLibrarySections();
        if (document.getElementById('search-view').classList.contains('active')) {
            // Re-run search if a search was active, or clear it. For simplicity, just clear.
            // Or better, just ensure any displayed cards are updated.
            // For now, if search results are on screen, assume they might be stale.
            // A more robust solution would re-filter and re-render based on current search terms.
        }
        if (document.getElementById('playlist-detail-view').classList.contains('active')) {
            const openPlaylistId = document.getElementById('playlistDetailName').dataset.playlistId;
            if (openPlaylistId) displayPlaylistDetail(openPlaylistId);
        }
        renderUserPlaylistsNav(); // Always update playlists in sidebar
    }


    // --- User Management & Admin ---
    function setCurrentUser() {
        const username = usernameInput.value.trim();
        const email = emailInput.value.trim().toLowerCase();

        if (!username) {
            alert('Username cannot be empty.');
            return;
        }
        currentUser = username;
        currentUserEmail = email; // Store email for admin check

        if (!usersData[currentUser]) {
            usersData[currentUser] = { email: email, recentlyPlayed: [], likedSongs: [], playlists: [] };
        } else {
            usersData[currentUser].email = email; // Update email if user "logs in" again
        }
        
        checkAdminStatus();
        updateCurrentUserDisplay();
        saveData(); // Save user data
        renderAllDynamicContent(); // Re-render sections like "Recently Played BY YOU"
    }

    function checkAdminStatus() {
        isAdmin = currentUser === 'Sharky' && currentUserEmail === 'sebbthemaker@gmail.com';
        adminBadge.style.display = isAdmin ? 'inline' : 'none';
    }

    function updateCurrentUserDisplay() {
        if (currentUser) {
            currentUserDisplay.textContent = currentUser;
            usernameInput.value = currentUser;
            if (usersData[currentUser] && usersData[currentUser].email) {
                emailInput.value = usersData[currentUser].email;
            } else {
                emailInput.value = '';
            }
        } else {
            currentUserDisplay.textContent = 'None';
            usernameInput.value = '';
            emailInput.value = '';
        }
        adminBadge.style.display = isAdmin ? 'inline' : 'none';
    }


    // --- Navigation ---
    function navigateToView(viewId) {
        views.forEach(view => view.classList.remove('active'));
        const targetView = document.getElementById(`${viewId}-view`);
        if (targetView) targetView.classList.add('active');
        
        navLinks.forEach(link => link.classList.remove('active-nav'));
        const activeLink = document.querySelector(`.sidebar nav li[data-view="${viewId}"]`);
        if (activeLink) activeLink.classList.add('active-nav');

        // Specific rendering logic based on view
        if (viewId === 'home') renderAllHomeSections();
        if (viewId === 'library') renderLibrarySections();
        if (viewId === 'search') document.getElementById('search-results-grid').innerHTML = '<p>Enter search term and click Search.</p>';
        if (viewId === 'upload') uploadForm.reset(); coverPreview.style.display = 'none';
    }

    // --- Song Card Creation & Rendering ---
    function createSongCard(song) {
        if (!song) return null; // Safety check

        // Visibility check: Admins see all. Users see non-private or their own private songs.
        if (!isAdmin && song.isPrivate && song.uploader !== currentUser) {
            return null; 
        }

        const card = document.createElement('div');
        card.className = 'song-card';
        card.dataset.songId = song.id;

        const coverImg = document.createElement('img');
        coverImg.className = 'cover';
        coverImg.src = song.coverUrl || 'https://via.placeholder.com/180?text=No+Cover';
        coverImg.alt = song.name;
        coverImg.onclick = () => openSongDetailModal(song.id); // Click cover for details

        const nameEl = document.createElement('p');
        nameEl.className = 'song-name';
        nameEl.textContent = song.name;

        const artistEl = document.createElement('p');
        artistEl.className = 'artist-name';
        artistEl.textContent = `${song.artist}`;
        
        const albumEl = document.createElement('p');
        albumEl.className = 'song-album';
        albumEl.textContent = `Album: ${song.album || 'N/A'}`;

        const uploaderEl = document.createElement('p');
        uploaderEl.className = 'uploader-name';
        uploaderEl.textContent = `Up: ${song.uploader || 'Unknown'}`;

        const playsEl = document.createElement('p');
        playsEl.className = 'song-plays';
        playsEl.textContent = `Plays: ${song.plays || 0}`;
        
        const likesEl = document.createElement('p');
        likesEl.className = 'song-likes';
        likesEl.textContent = `Likes: ${song.likes || 0}`;

        // Like button on card
        const likeButton = document.createElement('button');
        likeButton.className = 'like-button-card';
        likeButton.innerHTML = '&#x2661;'; // Empty heart
        if (currentUser && usersData[currentUser]?.likedSongs.includes(song.id)) {
            likeButton.classList.add('liked');
            likeButton.innerHTML = '&#x2665;'; // Filled heart
        }
        likeButton.onclick = (e) => {
            e.stopPropagation(); 
            toggleLike(song.id);
        };
        
        // Privacy status indicator
        if (song.isPrivate) {
            const privacyStatus = document.createElement('span');
            privacyStatus.className = 'privacy-status';
            privacyStatus.textContent = 'Private';
            card.appendChild(privacyStatus);
        }

        // Actions Overlay
        const actionsOverlay = document.createElement('div');
        actionsOverlay.className = 'actions-overlay';

        const playBtnOverlay = document.createElement('button');
        playBtnOverlay.textContent = 'Play';
        playBtnOverlay.onclick = (e) => { e.stopPropagation(); playSongById(song.id); };
        actionsOverlay.appendChild(playBtnOverlay);

        const addToPlaylistBtn = document.createElement('button');
        addToPlaylistBtn.textContent = 'Add to Playlist';
        addToPlaylistBtn.onclick = (e) => { e.stopPropagation(); openAddToPlaylistModal(song.id); };
        actionsOverlay.appendChild(addToPlaylistBtn);
        
        if (isAdmin) {
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.className = 'admin-action';
            editBtn.onclick = (e) => { e.stopPropagation(); openEditSongModal(song.id); };
            actionsOverlay.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'admin-action';
            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteSong(song.id); };
            actionsOverlay.appendChild(deleteBtn);
        }


        card.appendChild(coverImg);
        card.appendChild(nameEl);
        card.appendChild(artistEl);
        card.appendChild(albumEl);
        // card.appendChild(uploaderEl); // Can be too much info on card, available in detail
        card.appendChild(playsEl);
        card.appendChild(likesEl);
        card.appendChild(likeButton);
        card.appendChild(actionsOverlay);
        
        return card;
    }

    function renderSongGrid(songArray, gridElementId, emptyMessage = "No songs to display.") {
        const grid = document.getElementById(gridElementId);
        grid.innerHTML = ''; 
        if (songArray && songArray.length > 0) {
            let hasVisibleSongs = false;
            songArray.forEach(song => {
                const card = createSongCard(song);
                if (card) { // createSongCard returns null for non-visible private songs
                    grid.appendChild(card);
                    hasVisibleSongs = true;
                }
            });
            if (!hasVisibleSongs) {
                 grid.innerHTML = `<p>${emptyMessage}</p>`;
            }
        } else {
            grid.innerHTML = `<p>${emptyMessage}</p>`;
        }
    }

    // --- Home Page Sections ---
    function renderAllHomeSections() {
        renderRecentlyUploaded();
        renderMostPlayed();
        renderMostLiked();
        if (currentUser) renderRecentlyPlayedByYou();
        else document.getElementById('recently-played-grid').innerHTML = '<p>Set a user to see your recently played songs.</p>';
    }

    function renderRecentlyUploaded() {
        const visibleSongs = songs.filter(song => isAdmin || !song.isPrivate || song.uploader === currentUser);
        const sortedSongs = [...visibleSongs].sort((a, b) => b.uploadTimestamp - a.uploadTimestamp);
        renderSongGrid(sortedSongs.slice(0, 10), 'recently-uploaded-grid', 'No songs uploaded yet.');
    }

    function renderMostPlayed() {
        const visibleSongs = songs.filter(song => isAdmin || !song.isPrivate || song.uploader === currentUser);
        const sortedSongs = [...visibleSongs].sort((a, b) => (b.plays || 0) - (a.plays || 0));
        renderSongGrid(sortedSongs.slice(0, 10), 'most-played-grid', 'No songs played yet.');
    }
    
    function renderMostLiked() {
        const visibleSongs = songs.filter(song => isAdmin || !song.isPrivate || song.uploader === currentUser);
        const sortedSongs = [...visibleSongs].sort((a, b) => (b.likes || 0) - (a.likes || 0));
        renderSongGrid(sortedSongs.slice(0, 10), 'most-liked-grid', 'No songs liked yet.');
    }

    function renderRecentlyPlayedByYou() {
        if (!currentUser || !usersData[currentUser]) {
            document.getElementById('recently-played-grid').innerHTML = '<p>Set a user and play songs to see them here.</p>';
            return;
        }
        const recentIds = usersData[currentUser].recentlyPlayed || [];
        const recentSongs = recentIds.map(id => songs.find(s => s.id === id)).filter(Boolean);
        // Filter out songs that might have become private AND not owned by current user
        const visibleRecentSongs = recentSongs.filter(song => isAdmin || !song.isPrivate || song.uploader === currentUser);
        renderSongGrid(visibleRecentSongs, 'recently-played-grid', 'You haven\'t played any songs recently.');
    }
    
    // --- Library Sections ---
    function renderLibrarySections() {
        if (!currentUser) {
            document.getElementById('my-uploads-grid').innerHTML = '<p>Set a user to see your uploads.</p>';
            document.getElementById('my-liked-songs-grid').innerHTML = '<p>Set a user to see your liked songs.</p>';
            document.getElementById('my-playlists-grid').innerHTML = '<p>Set a user to see your playlists.</p>';
            return;
        }
        const myUploads = songs.filter(song => song.uploader === currentUser); // Shows private ones too, if they uploaded
        renderSongGrid(myUploads, 'my-uploads-grid', 'You haven\'t uploaded any songs.');

        const likedSongIds = usersData[currentUser]?.likedSongs || [];
        const myLikedSongs = likedSongIds.map(id => songs.find(s => s.id === id)).filter(Boolean)
                                    .filter(song => isAdmin || !song.isPrivate || song.uploader === currentUser); // Filter for visibility
        renderSongGrid(myLikedSongs, 'my-liked-songs-grid', 'You haven\'t liked any songs yet.');
        
        renderMyPlaylistsGrid();
    }

    // --- Music Player Logic ---
    function playSongById(songId, playlistContext = null, playlistIndex = -1) {
        const songToPlay = songs.find(s => s.id === songId);
        if (!songToPlay) {
            alert('Song not found.');
            return;
        }

        // Check if song has a blob (uploaded in current session)
        // This is a placeholder for the actual blob that needs to be associated.
        // When loading from localStorage, `songBlob` is not present.
        // We need to find the song object that might have the blob from a current session upload.
        const songWithBlob = songs.find(s => s.id === songId && s.songBlob);

        if (!songWithBlob || !songWithBlob.songBlob) {
            alert('Song file not available for playback. It might need to be re-uploaded in the current session.');
            // Attempt to find if any song with this ID has a blob, if multiple instances (should not happen with good IDing)
             const anyBlob = songs.find(s => s.id === songId && s.songBlob);
             if (!anyBlob || !anyBlob.songBlob) {
                playerBar.style.display = 'none';
                return;
             }
             // If found, try to use it (this is a bit of a hack for the single file limitation)
             songToPlay.songBlob = anyBlob.songBlob;
        } else {
            songToPlay.songBlob = songWithBlob.songBlob; // Ensure the main song object gets the blob
        }


        audioPlayer.src = URL.createObjectURL(songToPlay.songBlob);
        audioPlayer.play()
            .then(() => {
                playerBar.style.display = 'flex';
                playPauseButton.innerHTML = '❚❚'; // Pause symbol
            })
            .catch(error => {
                console.error("Error playing song:", error);
                alert("Could not play song. File might be corrupted or unsupported.");
                playerBar.style.display = 'none';
            });
        
        playerCover.src = songToPlay.coverUrl || 'https://via.placeholder.com/60?text=N/A';
        playerNameEl.textContent = songToPlay.name;
        playerArtistEl.textContent = songToPlay.artist;
        currentPlayingSongId = songToPlay.id;

        // Playlist context
        if (playlistContext) {
            currentPlaylist = playlistContext.map(id => songs.find(s => s.id === id)).filter(Boolean);
            currentPlaylistIndex = playlistIndex;
        } else {
            // If not in a playlist, create a "playlist" of just this song
            currentPlaylist = [songToPlay];
            currentPlaylistIndex = 0;
        }


        // Increment plays (only if not already played in last few seconds to avoid quick multiple counts)
        const now = Date.now();
        if (!songToPlay.lastPlayedTimestamp || (now - songToPlay.lastPlayedTimestamp > 5000)) { // 5s debounce
            songToPlay.plays = (songToPlay.plays || 0) + 1;
            songToPlay.lastPlayedTimestamp = now;
        }
        
        if (currentUser && usersData[currentUser]) {
            let recentlyPlayed = usersData[currentUser].recentlyPlayed || [];
            recentlyPlayed = [songToPlay.id, ...recentlyPlayed.filter(id => id !== songToPlay.id)].slice(0, 20);
            usersData[currentUser].recentlyPlayed = recentlyPlayed;
        }
        
        refreshAllViewsAndData(); // This calls saveData and re-renders
    }

    audioPlayer.onloadedmetadata = () => {
        totalTimeEl.textContent = formatTime(audioPlayer.duration);
        seekBar.max = audioPlayer.duration;
    };
    audioPlayer.ontimeupdate = () => {
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        seekBar.value = audioPlayer.currentTime;
    };
    seekBar.oninput = () => {
        audioPlayer.currentTime = seekBar.value;
    };
    audioPlayer.onended = () => {
        playNextTrack();
    };
    audioPlayer.onplay = () => {
        playerBar.style.display = 'flex';
        playPauseButton.innerHTML = '❚❚'; // Pause
    };
    audioPlayer.onpause = () => {
        // Don't hide bar on pause, only on explicit stop or end without repeat
        playPauseButton.innerHTML = '▶'; // Play
    };

    playPauseButton.onclick = () => {
        if (audioPlayer.paused) {
            audioPlayer.play().catch(e => console.error("Play error:", e));
        } else {
            audioPlayer.pause();
        }
    };
    
    volumeBar.oninput = () => {
        audioPlayer.volume = volumeBar.value;
        localStorage.setItem('freetify_volume', audioPlayer.volume);
        updateVolumeIcon();
    };

    function updateVolumeIcon() {
        if (audioPlayer.volume === 0) {
            volumeIcon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>'; // Muted
        } else if (audioPlayer.volume < 0.5) {
            volumeIcon.innerHTML = '<path d="M7 9v6h4l5 5V4L11 9H7zm7.5-1c0-.82-.31-1.57-.82-2.12L12 7.54v8.92l1.68-1.68c.51-.55.82-1.3.82-2.12z"/>'; // Low Volume
        } else {
            volumeIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>'; // Normal/High Volume
        }
    }

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${minutes}:${secs}`;
    }

    // --- Track Navigation (Next/Prev, Shuffle, Repeat) ---
    nextTrackButton.onclick = () => playNextTrack();
    prevTrackButton.onclick = () => playPreviousTrack();

    repeatButton.onclick = () => {
        if (repeatMode === 'none') {
            repeatMode = 'all';
            repeatButton.style.color = 'var(--accent-color)';
            repeatButton.innerHTML = '🔁¹'; // Indicate repeat one or all somehow
        } else if (repeatMode === 'all') {
            repeatMode = 'one';
            repeatButton.innerHTML = '🔂'; // Repeat one icon
        } else { // repeatMode === 'one'
            repeatMode = 'none';
            repeatButton.style.color = 'var(--text-secondary)';
            repeatButton.innerHTML = '🔁';
        }
    };

    shuffleButton.onclick = () => {
        isShuffle = !isShuffle;
        shuffleButton.style.color = isShuffle ? 'var(--accent-color)' : 'var(--text-secondary)';
        // If shuffle is turned on, and we're in a playlist, we might want to shuffle the *rest* of the playlist
        // For now, it will apply to the *next* track selection.
    };

    function playNextTrack() {
        if (repeatMode === 'one') {
            audioPlayer.currentTime = 0;
            audioPlayer.play();
            return;
        }

        if (!currentPlaylist || currentPlaylist.length === 0) return;
        
        let nextIndex;
        if (isShuffle) {
            nextIndex = Math.floor(Math.random() * currentPlaylist.length);
        } else {
            nextIndex = currentPlaylistIndex + 1;
        }

        if (nextIndex >= currentPlaylist.length) {
            if (repeatMode === 'all') {
                nextIndex = 0;
            } else {
                // End of playlist, no repeat all
                playerBar.style.display = 'none'; // Or stop, or play first song etc.
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                currentPlayingSongId = null;
                // Clear player display
                playerCover.src = '#';
                playerNameEl.textContent = 'Song Name';
                playerArtistEl.textContent = 'Artist';
                return;
            }
        }
        
        const nextSong = currentPlaylist[nextIndex];
        if (nextSong) {
            playSongById(nextSong.id, currentPlaylist.map(s=>s.id), nextIndex);
        }
    }

    function playPreviousTrack() {
        // If played for more than 3 seconds, restart current song, otherwise go to previous
        if (audioPlayer.currentTime > 3) {
            audioPlayer.currentTime = 0;
            return;
        }

        if (!currentPlaylist || currentPlaylist.length === 0) return;

        let prevIndex;
        if (isShuffle) { // Shuffle logic for prev might be complex, usually just goes to a random previous
            prevIndex = Math.floor(Math.random() * currentPlaylist.length); 
        } else {
            prevIndex = currentPlaylistIndex - 1;
        }

        if (prevIndex < 0) {
            if (repeatMode === 'all') {
                prevIndex = currentPlaylist.length - 1; // Loop to end
            } else {
                // Beginning of playlist, no repeat all
                audioPlayer.currentTime = 0; // Just restart current if at beginning
                return;
            }
        }
        
        const prevSong = currentPlaylist[prevIndex];
        if (prevSong) {
            playSongById(prevSong.id, currentPlaylist.map(s=>s.id), prevIndex);
        }
    }


    // --- Upload Logic ---
    coverFileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                coverPreview.src = e.target.result;
                coverPreview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        } else {
            coverPreview.src = '#';
            coverPreview.style.display = 'none';
        }
    };

    uploadForm.onsubmit = async (event) => {
        event.preventDefault();
        if (!currentUser) {
            alert('Please set a user before uploading.');
            return;
        }

        const songFile = songFileInput.files[0];
        const coverFile = document.getElementById('coverFile').files[0];
        const songName = document.getElementById('songName').value;
        const artistName = document.getElementById('artistName').value;
        const category = document.getElementById('category').value;
        const albumName = document.getElementById('albumName').value || 'No Album';

        songFileError.textContent = '';

        if (!songFile) { songFileError.textContent = 'Song file is required.'; return; }
        if (!['audio/mpeg', 'audio/mp3', 'audio/ogg'].includes(songFile.type)) {
            songFileError.textContent = 'Invalid song file type. MP3/OGG only.'; return;
        }
        if (!coverFile) { alert('Cover image is required.'); return; }
        if (!['image/png', 'image/jpeg', 'image/jpg'].includes(coverFile.type)) {
            alert('Invalid cover file type. PNG/JPG only.'); return;
        }

        const tempAudio = document.createElement('audio');
        const tempAudioSrc = URL.createObjectURL(songFile); // Keep this reference
        tempAudio.src = tempAudioSrc;

        tempAudio.onloadedmetadata = () => {
            URL.revokeObjectURL(tempAudioSrc); // Clean up temp URL
            if (tempAudio.duration > MAX_SONG_DURATION) {
                songFileError.textContent = `Song is too long (${formatTime(tempAudio.duration)}). Max 10 minutes.`;
                return;
            }

            const coverReader = new FileReader();
            coverReader.onload = (e) => {
                const newSong = {
                    id: 'song_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: songName,
                    artist: artistName,
                    album: albumName,
                    category: category,
                    coverUrl: e.target.result, // Data URL for cover
                    songBlob: songFile, // Store the actual blob for current session playback
                    duration: tempAudio.duration,
                    uploadTimestamp: Date.now(),
                    uploader: currentUser,
                    plays: 0,
                    likes: 0,
                    comments: [],
                    isPrivate: false // Default to public
                };

                songs.push(newSong);
                alert('Song uploaded successfully!');
                uploadForm.reset();
                coverPreview.style.display = 'none';
                refreshAllViewsAndData();
                navigateToView('home'); // Or library
            };
            coverReader.readAsDataURL(coverFile);
        };
        tempAudio.onerror = () => {
            URL.revokeObjectURL(tempAudioSrc);
            songFileError.textContent = 'Could not read song file to check duration.';
        };
    };

    // --- Like/Unlike Song ---
    function toggleLike(songId) {
        if (!currentUser || !usersData[currentUser]) {
            alert('Please set a user to like songs.');
            return;
        }
        const song = songs.find(s => s.id === songId);
        if (!song) return;

        const userLikes = usersData[currentUser].likedSongs || [];
        const songCard = document.querySelector(`.song-card[data-song-id="${songId}"]`);
        const likeButton = songCard ? songCard.querySelector('.like-button-card') : null;

        if (userLikes.includes(songId)) { // Unlike
            usersData[currentUser].likedSongs = userLikes.filter(id => id !== songId);
            song.likes = Math.max(0, (song.likes || 0) - 1);
            if (likeButton) {
                likeButton.classList.remove('liked');
                likeButton.innerHTML = '&#x2661;';
            }
        } else { // Like
            usersData[currentUser].likedSongs.push(songId);
            song.likes = (song.likes || 0) + 1;
             if (likeButton) {
                likeButton.classList.add('liked');
                likeButton.innerHTML = '&#x2665;';
            }
        }
        
        refreshAllViewsAndData();
    }

    // --- Search Logic ---
    filterTypeSelect.onchange = () => {
        const requiresValue = ['uploader', 'artist', 'album', 'category'].includes(filterTypeSelect.value);
        filterValueInput.style.display = requiresValue ? 'inline-block' : 'none';
        if (requiresValue) filterValueInput.placeholder = `Enter ${filterTypeSelect.value} name`;
    };

    searchButton.onclick = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filterType = filterTypeSelect.value;
        const filterValue = filterValueInput.value.toLowerCase();
        let results = [...songs];

        // Filter for visibility first
        results = results.filter(song => isAdmin || !song.isPrivate || song.uploader === currentUser);

        if (searchTerm) {
            results = results.filter(song => 
                song.name.toLowerCase().includes(searchTerm) ||
                song.artist.toLowerCase().includes(searchTerm) ||
                (song.album && song.album.toLowerCase().includes(searchTerm)) ||
                (song.category && song.category.toLowerCase().includes(searchTerm))
            );
        }

        switch (filterType) {
            case 'recent':
                results.sort((a, b) => b.uploadTimestamp - a.uploadTimestamp);
                break;
            case 'uploader':
                if (filterValue) results = results.filter(song => song.uploader && song.uploader.toLowerCase().includes(filterValue));
                break;
            case 'artist':
                if (filterValue) results = results.filter(song => song.artist.toLowerCase().includes(filterValue));
                break;
            case 'album':
                if (filterValue) results = results.filter(song => song.album && song.album.toLowerCase().includes(filterValue));
                break;
            case 'category':
                 if (filterValue) results = results.filter(song => song.category && song.category.toLowerCase().includes(filterValue));
                break;
            case 'most_played':
                results.sort((a, b) => (b.plays || 0) - (a.plays || 0));
                break;
            case 'most_liked':
                results.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                break;
        }
        renderSongGrid(results, 'search-results-grid', 'No songs found matching your criteria.');
    };

    // --- Modal Management ---
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    document.querySelectorAll('.close-button').forEach(btn => {
        btn.onclick = () => closeModal(btn.dataset.modalId);
    });
    window.onclick = (event) => { // Close modal if clicking outside
        if (event.target.classList.contains('modal')) {
            closeModal(event.target.id);
        }
    };

    // --- Admin Song Management (Edit, Delete, Private) ---
    function openEditSongModal(songId) {
        if (!isAdmin) return;
        const song = songs.find(s => s.id === songId);
        if (!song) return;

        document.getElementById('editSongId').value = song.id;
        document.getElementById('editSongName').value = song.name;
        document.getElementById('editArtistName').value = song.artist;
        document.getElementById('editAlbumName').value = song.album || '';
        document.getElementById('editCategory').value = song.category || 'Other';
        document.getElementById('editIsPrivate').checked = song.isPrivate || false;
        openModal('editSongModal');
    }

    editSongForm.onsubmit = (event) => {
        event.preventDefault();
        if (!isAdmin) return;
        
        const songId = document.getElementById('editSongId').value;
        const song = songs.find(s => s.id === songId);
        if (!song) return;

        song.name = document.getElementById('editSongName').value;
        song.artist = document.getElementById('editArtistName').value;
        song.album = document.getElementById('editAlbumName').value || 'No Album';
        song.category = document.getElementById('editCategory').value;
        song.isPrivate = document.getElementById('editIsPrivate').checked;
        
        refreshAllViewsAndData();
        closeModal('editSongModal');
        alert('Song updated.');
    };

    function deleteSong(songId) {
        if (!isAdmin) return;
        if (!confirm('Are you sure you want to delete this song? This action cannot be undone.')) return;

        songs = songs.filter(s => s.id !== songId);
        // Remove from user likes and playlists
        Object.values(usersData).forEach(user => {
            if (user.likedSongs) user.likedSongs = user.likedSongs.filter(id => id !== songId);
            if (user.recentlyPlayed) user.recentlyPlayed = user.recentlyPlayed.filter(id => id !== songId);
            if (user.playlists) {
                user.playlists.forEach(p => {
                    p.songIds = p.songIds.filter(id => id !== songId);
                });
            }
        });
        
        refreshAllViewsAndData();
        alert('Song deleted.');
    }

    // --- Song Detail Modal & Comments ---
    function openSongDetailModal(songId) {
        const song = songs.find(s => s.id === songId);
        if (!song) return;

        document.getElementById('detailCover').src = song.coverUrl || 'https://via.placeholder.com/150?text=No+Cover';
        document.getElementById('detailName').textContent = song.name;
        document.getElementById('detailArtist').textContent = song.artist;
        document.getElementById('detailAlbum').textContent = `Album: ${song.album || 'N/A'}`;
        document.getElementById('detailCategory').textContent = `Category: ${song.category || 'Other'}`;
        document.getElementById('detailUploader').textContent = `Uploaded by: ${song.uploader || 'Unknown'}`;
        document.getElementById('detailPlays').textContent = `Plays: ${song.plays || 0}`;
        document.getElementById('detailLikes').textContent = `Likes: ${song.likes || 0}`;

        document.getElementById('commentSongId').value = song.id;
        renderComments(song.id);
        openModal('songDetailModal');
    }

    function renderComments(songId) {
        const song = songs.find(s => s.id === songId);
        commentsList.innerHTML = '';
        if (song && song.comments && song.comments.length > 0) {
            song.comments.slice().reverse().forEach(comment => { // Show newest first
                const div = document.createElement('div');
                div.className = 'comment';
                div.innerHTML = `
                    <span class="comment-user">${comment.user}</span>
                    <span class="comment-time">${new Date(comment.timestamp).toLocaleString()}</span>
                    <p class="comment-text">${escapeHTML(comment.text)}</p>
                `;
                commentsList.appendChild(div);
            });
        } else {
            commentsList.innerHTML = '<p>No comments yet.</p>';
        }
    }

    commentForm.onsubmit = (event) => {
        event.preventDefault();
        if (!currentUser) {
            alert('Please set a user to comment.');
            return;
        }
        const songId = document.getElementById('commentSongId').value;
        const text = document.getElementById('commentText').value.trim();
        if (!text) return;

        const song = songs.find(s => s.id === songId);
        if (!song) return;

        if (!song.comments) song.comments = [];
        song.comments.push({
            user: currentUser,
            text: text,
            timestamp: Date.now()
        });

        refreshAllViewsAndData();
        renderComments(songId); // Re-render comments in the modal
        document.getElementById('commentText').value = '';
    };

    function escapeHTML(str) { // Basic XSS protection for comments
        return str.replace(/[&<>"']/g, function (match) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
        });
    }

    // --- Playlist Management ---
    document.getElementById('createPlaylistButton').onclick = () => {
        if (!currentUser || !usersData[currentUser]) {
            alert('Please set a user to create playlists.');
            return;
        }
        const playlistName = document.getElementById('createPlaylistInput').value.trim();
        if (!playlistName) {
            alert('Playlist name cannot be empty.');
            return;
        }
        if (!usersData[currentUser].playlists) usersData[currentUser].playlists = [];
        
        // Check if playlist name already exists for this user
        if (usersData[currentUser].playlists.some(p => p.name === playlistName)) {
            alert(`Playlist "${playlistName}" already exists.`);
            return;
        }

        usersData[currentUser].playlists.push({
            id: 'pl_' + Date.now() + '_' + Math.random().toString(36).substr(2,9),
            name: playlistName,
            songIds: []
        });
        document.getElementById('createPlaylistInput').value = '';
        refreshAllViewsAndData();
    };

    function renderUserPlaylistsNav() {
        const listEl = document.getElementById('user-playlists-list');
        listEl.innerHTML = '';
        if (currentUser && usersData[currentUser] && usersData[currentUser].playlists) {
            usersData[currentUser].playlists.forEach(pl => {
                const li = document.createElement('li');
                li.textContent = pl.name;
                li.dataset.playlistId = pl.id;
                li.onclick = () => {
                    navigateToView('playlist-detail');
                    displayPlaylistDetail(pl.id);
                };
                listEl.appendChild(li);
            });
        }
    }
    
    function renderMyPlaylistsGrid() {
        const gridEl = document.getElementById('my-playlists-grid');
        gridEl.innerHTML = '';
        if (currentUser && usersData[currentUser] && usersData[currentUser].playlists && usersData[currentUser].playlists.length > 0) {
            usersData[currentUser].playlists.forEach(pl => {
                const card = document.createElement('div');
                card.className = 'playlist-card';
                card.innerHTML = `<h4>${escapeHTML(pl.name)}</h4><p>${pl.songIds.length} song(s)</p>`;
                card.onclick = () => {
                    navigateToView('playlist-detail');
                    displayPlaylistDetail(pl.id);
                };
                gridEl.appendChild(card);
            });
        } else {
            gridEl.innerHTML = '<p>You haven\'t created any playlists.</p>';
        }
    }


    function displayPlaylistDetail(playlistId) {
        if (!currentUser || !usersData[currentUser]) return;
        const playlist = usersData[currentUser].playlists.find(p => p.id === playlistId);
        if (!playlist) {
            navigateToView('library'); // Playlist not found, go back
            return;
        }
        document.getElementById('playlistDetailName').textContent = `Playlist: ${escapeHTML(playlist.name)}`;
        document.getElementById('playlistDetailName').dataset.playlistId = playlist.id; // Store for refresh

        const playlistSongs = playlist.songIds.map(id => songs.find(s => s.id === id)).filter(Boolean)
                                   .filter(song => isAdmin || !song.isPrivate || song.uploader === currentUser); // visibility

        renderSongGrid(playlistSongs, 'playlist-songs-grid', 'This playlist is empty or songs are not accessible.');
        
        // Add ability to play all songs in this playlist
        // Could add a "Play All" button here, which would set currentPlaylist
    }
    document.getElementById('backToLibraryButton').onclick = () => navigateToView('library');


    function openAddToPlaylistModal(songId) {
        if (!currentUser || !usersData[currentUser]) {
            alert('Please set a user to add songs to playlists.');
            return;
        }
        document.getElementById('songIdToAddToPlaylist').value = songId;
        const selectEl = document.getElementById('playlistSelectForAdding');
        selectEl.innerHTML = '';
        if (usersData[currentUser].playlists && usersData[currentUser].playlists.length > 0) {
            usersData[currentUser].playlists.forEach(pl => {
                const option = document.createElement('option');
                option.value = pl.id;
                option.textContent = pl.name;
                selectEl.appendChild(option);
            });
            openModal('addToPlaylistModal');
        } else {
            alert('You have no playlists. Create one first from the sidebar.');
        }
    }

    document.getElementById('confirmAddToPlaylistButton').onclick = () => {
        const songId = document.getElementById('songIdToAddToPlaylist').value;
        const playlistId = document.getElementById('playlistSelectForAdding').value;
        if (!songId || !playlistId) return;

        const playlist = usersData[currentUser].playlists.find(p => p.id === playlistId);
        if (playlist) {
            if (!playlist.songIds.includes(songId)) {
                playlist.songIds.push(songId);
                refreshAllViewsAndData();
                alert('Song added to playlist.');
            } else {
                alert('Song is already in this playlist.');
            }
        }
        closeModal('addToPlaylistModal');
    };


    // --- Event Listeners Setup ---
    function setupEventListeners() {
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                // Check if it's a sub-item, if so, its parent might also have a data-view
                let viewTarget = e.currentTarget.dataset.view;
                if (!viewTarget && e.currentTarget.parentElement.closest('li[data-view]')) {
                    viewTarget = e.currentTarget.parentElement.closest('li[data-view]').dataset.view;
                }
                 if (viewTarget) navigateToView(viewTarget);
            });
        });

        setUserButton.addEventListener('click', setCurrentUser);
        usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') setUserButton.click(); });
        emailInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') setUserButton.click(); });
    }

    // --- Run on Page Load ---
    document.addEventListener('DOMContentLoaded', init);
    // --- END OF SCRIPT --- //
    </script>
</body>
</html> 
